---
title: "BC AF Trade Tool Build"
author: "Leila Bautista and Brendan Dwyer"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

# BC AF Trade Tool Build

This RMarkdown provides chunks of R code to load, filter and combine data from Open Government [website](https://search.open.canada.ca/opendata/?sort=metadata_modified+desc&search_text=cimt&page=1). The trade data is used by the Ministry of Agriculture and Food's SITS Unit to produce various deliverables that estimate BC and other provincial trade of agriculture and food commodities.

Contact [alstats\@gov.bc.ca](mailto:alstats@gov.bc.ca) for any questions. The following are key steps:

1.  Set-up and load library
2.  Load historic data for a. domestic export\* and b. import by time period (e.g., 2023-2025, 2017-2022, etc.)
3.  Merge all years of each period into 1 data frame for each period
4.  Write a .csv file into Unpublished Data Library for each period's a. domestic export and b. import

\*A new chunk to load **c. Total export** could be written

# Set-up & Library

```{r Set-up, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# sets the time-out option to 250 mins
options(timeout = 15000)
```

```{r Library}

# Load library
library(pacman)
p_load(dplyr,
       data.table,
       tidyr,
       lubridate,
       tictoc,
       splitstackshape,
       stringr)
```

# Load Historic Data

The format and script to load data from Open Government changes because the structure of the zip file changes over time. There are 2 chunks of code involved to load the update for each of:

-   a\. Domestic export

-   b\. Import

As of February 2026, SITS cannot yet directly connect to a SharePoint URL to access the shared Unpublished Data library. The interim workaround is to sync that library to the user's Desktop and change the URL manually. Remember to replace "\\" with "/" and note that the timeout settings is 10 mins because the zip file is large and the default timeout of 1 min is insufficient to download and unzip the file.

### Domestic Export

-   The URL for the .zip file changes and needs updating. It is formatted like:

```         
https://www150.statcan.gc.ca/n1/pub/##-###-x/#######/zip/CIMT-CICM_Dom_Exp_YYYY.zip
```

-   Confirm the download structure is such that a the file that starts with "ODPFN016\_" is inside another folder when unzipped formatted as "CIMT-CICM_Dom_Exp_YYYY".

-   Download the zip file: load the specific file with export value data at the HS8-level into a data frame called **df**.

-   Clean the data: rename columns and specifying types (e.g., text, numeric, etc.)

-   Filter the full data frame: load the specific list of HS8 codes from AAFC's CATSNET related to agriculture and food into a data framed called **Commodity_REF** and left join with **df,** to filter only for matching HS8 codes

-   Define the years in the for loop and the merging all domestic exports and imports by period into a a data frame and write as a .csv file in the working directory

```{r Domestic Export}
# Start timer
tic()

# Set working directory
setwd("C:/Users/lebautis/Government of BC/SICI Data Library Subsite - Unpublished Data")

# Define the min and max years (EDIT THIS as needed) for loop and binding
years <- 2015:2025

# Load Commodity reference ONCE (outside loop)
Commodity_REF <- fread(
  "CATSNET HS8.csv",
  colClasses = c(HS8_code = "character")
)

for (yr in years) {
  
  message("Processing year: ", yr)
  
  # Build URL dynamically
  url <- paste0(
    "https://www150.statcan.gc.ca/n1/pub/71-607-x/2021004/zip/",
    "CIMT-CICM_Dom_Exp_",
    yr,
    ".zip"
  )
  
  zip_file <- tempfile(fileext = ".zip")
  
  # Download
  download.file(url, zip_file, mode = "wb", method = "libcurl")
  
  # Inspect ZIP
  zip_contents <- unzip(zip_file, list = TRUE)
  
  csv_file <- zip_contents$Name[
    grepl("ODPFN016_.*\\.csv$", zip_contents$Name)
  ]
  
  # Read CSV
  df <- read.csv(
    unz(zip_file, csv_file),
    colClasses = c(
      HS8 = "character",
      Value.Valeur = "numeric",
      Quantity.Quantité = "numeric"
    ),
    stringsAsFactors = FALSE
  )
  
  # Unlink the temporary zip_file
  unlink(zip_file)
  
  # Clean + rename
  df <- df %>% 
    rename(
      Date = `YearMonth.AnnéeMois`,
      HS8_code = `HS8`,
      Country = `Country.Pays`,
      State = `State.État`,
      Value = `Value.Valeur`,
      Quantity = `Quantity.Quantité`,
      UOM = `Unit.of.Measure.Unité.de.Mesure`
    ) %>% 
    select(1:8)
  
  # Format the Date column as data
  df$Date <- ym(df$Date)
  
  # Merge with commodity reference
  df <- df %>%
    merge(Commodity_REF, by = "HS8_code") %>%
    rename(HS_description = HS8_description)
  
  # Assign dynamically named dataframe
  assign(paste0("DomExport_Update_", yr), df, envir = .GlobalEnv)
  
  message("Finished year: ", yr)
}

# Define the object names based on the years specified above
obj_names <- paste0("DomExport_Update_", years)

# Creates a list out of the object names 
list <- mget(obj_names, envir = .GlobalEnv)

# Row bind into a timeseries data frame 
Trade_DomExport <- rbindlist(list, use.names = TRUE, fill = TRUE)

# Write the csv file with same dynamic name into the working directory
fwrite(Trade_DomExport, 
       "C:/Users/lebautis/Government of BC/SICI Data Library Subsite - Unpublished Data/Trade_DomExport.csv",
       row.names = FALSE,
       col.names = TRUE,
       buffMB = 10)

# Clean up helper objects
rm(df, list, obj_names)

# Stop timer
toc()
```

### Import

-   The URL for the .zip file changes and needs updating. It is formatted like:

```         
https://www150.statcan.gc.ca/n1/pub/##-###-x/#######/zip/CIMT-CICM_Dom_Exp_YYYY.zip
```

-   Regardless of the structure, find the file that starts with "ODPFN014\_" which might be inside another folder when unzipped formatted as "CIMT-CICM_Imp_YYYY".

-   Download the zip file: load the specific file with export value data at the HS10-level into a data frame called **df**.

-   Clean the data: rename columns and specifying types (e.g., text, numeric, etc.)

-   Filter the full data frame: load the specific list of HS10 codes from AAFC's CATSNET related to agriculture and food into a data framed called **Commodity_REF** and left join with **df,** to filter only for matching HS10 codes

-   Define the years in the for loop and the merging all domestic exports and imports by period into a a data frame and write as a .csv file in the working directory

```{r Import}
# Start timer
tic()

# Set working directory
setwd("C:/Users/lebautis/Government of BC/SICI Data Library Subsite - Unpublished Data")

# Define the years (EDIT THIS as needed) for loop and binding
years <- 2015:2025

# Load Commodity reference ONCE (outside loop)
Commodity_REF <- fread(
  "CATSNET HS10.csv",
  colClasses = c(HS10_code = "character")
)

for (yr in years) {
  
  message("Processing year: ", yr)
  
  # Build URL dynamically
  url <- paste0(
    "https://www150.statcan.gc.ca/n1/pub/71-607-x/2021004/zip/",
    "CIMT-CICM_Imp_",
    yr,
    ".zip"
  )
  
  zip_file <- tempfile(fileext = ".zip")
  
  # Download
  download.file(url, zip_file, mode = "wb", method = "libcurl")
  
  # Inspect ZIP
  zip_contents <- unzip(zip_file, list = TRUE)
  
  csv_file <- zip_contents$Name[
    grepl("ODPFN014_.*\\.csv$", zip_contents$Name)
  ]
  
  # Read CSV
  df <- read.csv(
    unz(zip_file, csv_file),
    colClasses = c(
      HS10 = "character",
      Value.Valeur = "numeric",
      Quantity.Quantité = "numeric"
    ),
    stringsAsFactors = FALSE
  )
  
  # unlink temporary zip_file
  unlink(zip_file)
  
  # Clean + rename
  df <- df %>% 
    rename(
      Date = `YearMonth.AnnéeMois`,
      HS10_code = `HS10`,
      Country = `Country.Pays`,
      State = `State.État`,
      Value = `Value.Valeur`,
      Quantity = `Quantity.Quantité`,
      UOM = `Unit.of.Measure.Unité.de.Mesure`
    ) %>% 
    select(1:8)
  
  # Format the Date column as data  
  df$Date <- ym(df$Date)
  
  # Merge with commodity reference
  df <- df %>%
    merge(Commodity_REF, by = "HS10_code") %>%
    rename(HS_description = HS10_description)
  
  # Assign dynamically named dataframe
  assign(paste0("Import_Update_", yr), df, envir = .GlobalEnv)
  
  message("Finished year: ", yr)
}

# Define the object names based on the years specified above
obj_names <- paste0("Import_Update_", years)

# Creates a list out of the object names 
list <- mget(obj_names, envir = .GlobalEnv)

# Row bind into a timeseries data frame 
Trade_Import <- rbindlist(list, use.names = TRUE, fill = TRUE)

# Write the csv file with same dynamic name into the working directory
fwrite(Trade_Import, 
       "C:/Users/lebautis/Government of BC/SICI Data Library Subsite - Unpublished Data/Trade_Import.csv",
       row.names = FALSE,
       col.names = TRUE,
       buffMB = 10)

# Clean up helper objects
rm(df, list, obj_names)

# Stop timer
toc()
```
